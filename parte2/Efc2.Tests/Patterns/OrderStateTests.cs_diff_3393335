using Efc2.Models;
using Efc2.Patterns.State;
using Efc2.Patterns.Factory;
using Moq;
using Xunit;

namespace Efc2.Tests.Patterns
{
    public class OrderStateTests
    {
        [Fact]
        public void NewOrder_ShouldStartInNewState()
        {
            // Arrange & Act
            var order = new Order();

            // Assert
            Assert.Equal("New", order.Status);
        }

        [Fact]
        public void Pay_ShouldTransitionFromNewToPaid()
        {
            // Arrange
            var order = new Order();
            
            // Mock Payment Method to avoid real processing logic/errors
            var mockPayment = new Mock<IPaymentMethod>();
            mockPayment.Setup(p => p.Process(It.IsAny<decimal>())).Returns("Payment Accepted");
            order.PaymentMethod = mockPayment.Object;

            // Act
            order.Pay();

            // Assert
            Assert.Equal("Paid", order.Status);
        }

        [Fact]
        public void Ship_ShouldThrowException_WhenOrderIsNew()
        {
            // Arrange
            var order = new Order();

            // Act & Assert
            var exception = Assert.Throws<InvalidOperationException>(() => order.Ship());
            Assert.Equal("Cannot ship an unpaid order.", exception.Message);
        }

        [Fact]
        public void Cancel_ShouldTransitionFromNewToCancelled()
        {
            // Arrange
            var order = new Order();

            // Act
            order.Cancel();

            // Assert
            Assert.Equal("Cancelled", order.Status);
        }

        [Fact]
        public void Ship_ShouldTransitionFromPaidToShipped()
        {
            // Arrange
            var order = new Order();
            
            // Setup Payment
            var mockPayment = new Mock<IPaymentMethod>();
            order.PaymentMethod = mockPayment.Object;
            
            // Move to Paid state
            order.Pay(); 

            // Act
            order.Ship();

            // Assert
            Assert.Equal("Shipped", order.Status);
        }
    }
}

